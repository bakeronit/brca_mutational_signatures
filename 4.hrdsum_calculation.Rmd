---
title: "HRDsum scores"
output: github_document
---

```{r setup0, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(CHORD)
library(BSgenome.Hsapiens.UCSC.hg38)
library(RColorBrewer)
library(here)

source("scripts/plot_utils.R")
source("scripts/hrdsum.R")
load("data/hrdsum_chrominfo.rda")

cohort_levels <- c("Familial Breast","TCGA","MAGIC","Q-IMPROvE")
extra_tumours <- c("QIPAH006_20230927_0012", "QIPAH011_20230927_0017", "QIPAH013_20230927_0029", "QIPAH002_20230927_0023","2020_118T2")
knitr::opts_chunk$set(root.dir = here(), comment = NA, echo = FALSE, message = FALSE, warnings = FALSE, include = TRUE, fig.align = 'center', fig.retina = 2, fig.path = "figures/", cache.path ="cache/")
```


The HRDsum scores were calculated using the `scar_score()` function of [modified scripts](scripts/hrdsum.R) based on scarHRD package. 


```{r, cache=TRUE, eval=FALSE}
run_hrdsum <- function(cnv_file) {
  sample <- basename(cnv_file) |> str_remove(".cnv.txt")
  read.table(cnv_file,header=T, check.names = F, stringsAsFactors = F, sep="\t") |> 
    select(Chromosome, chromStart, chromEnd, total.copy.number.inTumour, minor.copy.number.inTumour) |> 
    mutate(cn_B=total.copy.number.inTumour-minor.copy.number.inTumour, Chromosome=paste0("chr",Chromosome)) |> 
    add_column(ploidy=0, sample=sample) |> 
    select(sample,everything()) |> 
    scar_score() |> 
    as.data.frame()
}

df_hrdsum <- list.files("data/GRCh38", pattern = "*.cnv.txt", recursive = TRUE, full.names = TRUE) |> set_names(\(x) basename(x) |> str_remove(".cnv.txt")) |> 
  map(run_hrdsum) |>  list_rbind(names_to = "sample")

df_hrdsum |> write_tsv("results/hrdsum_355.tsv")
```


```{r}
df_hrdsum <- read_tsv("results/chord_hrdprediction_355.tsv") |>
  left_join(read_tsv("results/hrdsum_355.tsv"), by="sample") |> 
  mutate(sample_id=case_when(startsWith(sample,"MAGIC")~str_split_i(sample,"\\.",i=1),
                             startsWith(sample,"GQ")~str_split_i(sample,"\\.",i=1),
                             TRUE~sample),
         tumour_id=case_when(startsWith(sample,"MAGIC")~str_split_i(sample,"\\.",i=2),
                             startsWith(sample,"GQ")~str_split_i(sample,"\\.",i=2),
                             TRUE~sample)) |> 
  filter(!tumour_id %in% extra_tumours) |> 
  mutate(cohort=case_when(startsWith(sample,"MAGIC")~"MAGIC",
                          startsWith(sample,"TCGA")~"TCGA",
                          startsWith(sample,"FBC")~"Familial Breast",
                          startsWith(sample,"GQ")~"Q-IMPROvE")) |> 
  arrange(desc(`HRD-sum`)) |> 
  mutate(sample_id=factor(sample_id,levels=sample_id), 
         hr_status=ifelse(hr_status=="HR_deficient","HRD", "non-HRD"), 
         cohort=factor(cohort, levels=cohort_levels))
```

There is no threshold for HRDsum score for distinguishing HRD samples from non-HRD samples.

```{r hrdsum_fig1, fig.width=4, fig.height=4}
df_hrdsum |> 
  ggplot(aes(x=sample_id, y=`HRD-sum`)) +
  geom_point(alpha=.6, color="#3B4992") + 
  theme_Publication() + labs(x="Tumour samples",y="HRDsum score") + 
  theme(legend.position = "bottom", axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

We did see higher HRDsum scores for HRD samples (CHORD) than non-HRD samples, but there are many overlapping points especially other cohorts than those Familial breast cancers.

```{r hrdsum_fig2, fig.width=7, fig.height=4.5}
df_hrdsum |> 
  ggplot(aes(x=hr_status, y=`HRD-sum`, color=hr_status)) + 
  scale_color_manual(values=c("#0073C2","#EFC000")) +
  geom_boxplot() + facet_grid(~cohort) + 
  geom_jitter(position=position_jitter(0.2))+
  theme_Publication() + 
  labs(x="", y="HRDsum score", color="")
```


```{r hrdsum_fig3, fig.height=4, fig.width=4}
df_hrdsum |> 
  ggplot(aes(x=hr_status, y=`HRD-sum`, color=hr_status)) + 
  scale_color_manual(values=c("#0073C2","#EFC000")) +
  geom_boxplot() +
  geom_jitter() +
  theme_Publication() + 
  labs(x="", y="HRDsum score", color="")
```
