---
title: "Comparison of the HRD prediction from HRDetect and CHORD"
output: github_document
---

```{r setup0, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(RColorBrewer)
library(here)
library(yaml)
library(patchwork)
source("scripts/plot_utils.R")
config <- read_yaml("config.yaml")
extra_tumours <- config$extra_tumours
knitr::opts_chunk$set(root.dir = here(), comment = NA, echo = FALSE, message = FALSE, warnings = FALSE, include = TRUE, fig.align = 'center', fig.retina = 2, fig.path = "figures/", cache.path ="cache/")
```

Both HRDetect and CHORD had accurately predict HRD samples in the Familial breast cancer cohort as Nones et al., 2019. For other cohorts, there are five individuals been classified differently by two models.

```{r}
hrdetect_hrd <- read_tsv("results/hrdetect_hrdprediction_355.tsv")
chord_hrd <- read_tsv("results/chord_hrdprediction_355.tsv")

df_hrd <- hrdetect_hrd |>  inner_join(chord_hrd, by = "sample") |> 
  dplyr::select(sample,Probability,p_hrd,hr_status) |> 
  separate_wider_delim(sample,".", names = c("sample_id","tumour_id"), too_few = "align_start") |> 
  filter(!tumour_id %in% extra_tumours) |> select(-tumour_id) |> 
  dplyr::rename("HRDetect" = Probability, "CHORD"="p_hrd") |> 
  mutate(hr_status_combined=case_when(HRDetect>=0.7 & hr_status=="HR_deficient"~"HRD", 
                                 HRDetect<0.7 & hr_status=="HR_proficient" ~ "non-HRD", 
                                 TRUE~"Inconsistent" ) ) |> 
  mutate(cohort=case_when(grepl("FBC",sample_id) ~ "Familial Breast",
                                     grepl("TCGA",sample_id) ~ "TCGA",
                                     grepl("MAGIC",sample_id) ~ "MAGIC",
                                     TRUE ~ "Q-IMPROvE"),
         cohort=factor(cohort, levels=c("Familial Breast","TCGA","MAGIC","Q-IMPROvE"))) 

hrdsum <- read_tsv("results/hrdsum_355.tsv") |> separate_wider_delim(sample,".", names = c("sample_id","tumour_id"), too_few = "align_start") |> 
  filter(!tumour_id %in% extra_tumours) |> select(-tumour_id)

df_hrd |> filter(hr_status_combined=="Inconsistent") |> left_join(hrdsum) |> select(sample_id, HRDetect,CHORD, `HRD-sum`) |> knitr::kable()
```


```{r hrd_comparison_fig1, fig.width=6.8, fig.height=5}
p1 <- df_hrd |> mutate(hr_status_combined=factor(hr_status_combined,levels=c("HRD","non-HRD","Inconsistent"))) |> 
  ggplot(aes(x=CHORD,y=HRDetect, color=hr_status_combined)) + 
  geom_point(size=2.5, alpha=.6) + scale_color_manual(values=c("#0073C2","#EFC000","grey")) + 
  ggrepel::geom_label_repel(data=df_hrd |> filter(hr_status_combined=="Inconsistent"), aes(label=sample_id), size=1.6, color="black") + 
  geom_vline(xintercept = 0.5, color="darkgrey", lty=2, linewidth=1) + geom_hline(yintercept=0.7, lty=2, linewidth=1, color="darkgrey") + 
  labs(x="CHORD",y="HRDetect", color="") + theme_Publication() + theme(panel.border = element_rect(colour = 'black'))
p1
```

Notably, four out of these five samples were excluded by [germline classification](xx), and `TCGA-A7-A13D` is classified as brca_negative which is consistent with CHORD result.




```{r hrd_comparison_fig2, fig.height=4.5, fig.width=4.8}
df_tmp <- df_hrd|> group_by(cohort) |> mutate(total=n()) |> add_count(hr_status_combined) |> filter(hr_status_combined=="HRD") 

p2 <- ggplot() + geom_bar(data=df_hrd |>  mutate(hr_status_combined=factor(hr_status_combined,levels=c("HRD","non-HRD","Inconsistent"))), aes(x=cohort, fill=hr_status_combined),stat = "count") + 
  geom_text(data=df_tmp, aes(x=cohort, y=total, label=paste0(n,"/",total)), vjust=-.1, color="black") +
  scale_fill_manual(values=c("#0073C2","#EFC000","grey"))+ 
  theme_Publication() + labs(x="",y="Number of samples", fill="HR status") + 
  theme(legend.position = "bottom")  

p2 
```

For samples that are consistently predicted as HRD, CHORD further classified them as BRCA1/2 type.

```{r hrd_comparison_fig3, fig.height=4.5, fig.width=4.8}
chord_brca12 <- chord_hrd |> separate_wider_delim(sample,".", names = c("sample_id","tumour_id"), too_few = "align_start") |> 
  filter(!tumour_id %in% extra_tumours) |> select(sample_id, hrd_type) |> left_join(df_hrd)

my_blues <- brewer.pal(3,"Blues") |> rev()
p3 <- chord_brca12 |> filter(hr_status_combined=="HRD") |> 
  ggplot(aes(x=cohort,fill=hrd_type)) + geom_bar() + scale_fill_manual(values=my_blues, labels=c("BRCA1","BRCA2","Undetermined")) +
  #geom_text(aes(label=..count..),stat = "count", vjust =1.5,position = "stack", size=3.2) + 
  theme_Publication() + labs(x="",y="Number of samples", fill="HRD type") + 
  theme(legend.position = "bottom") 
p3
```